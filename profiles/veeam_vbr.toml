# LogSleuth Format Profile: Veeam Backup & Replication
#
# Covers VBR service logs (Svc.VeeamBackup.log, Svc.VeeamBroker.log, etc.)
# and job logs (Job.*.log). These all use the same bracketed format:
#
#   [23.11.2016 23:07:16] <01> Info     ------- Veeam Endpoint Job Started -------
#   [23.11.2016 23:07:16] <01> Error    Failed to connect to host 10.0.0.5
#
# Format: [DD.MM.YYYY HH:MM:SS] <ThreadID> Level     Message
#
# Log locations:
#   Windows: %ProgramData%\Veeam\Backup\
#   Linux:   /var/log/VeeamBackup/

[profile]
id = "veeam-vbr"
name = "Veeam Backup & Replication"
version = "1.0"
description = "VBR service, job, agent, CDP, plugin, FLR, transport, and explorer logs"
log_locations = [
    "Windows: %ProgramData%\\Veeam\\Backup\\",
    "Linux: /var/log/VeeamBackup/",
]

[detection]
file_patterns = [
    # ── Core service logs (Svc. prefix) ──────────────────────────────────────
    "Svc.Veeam*.log",
    "Svc.Veeam*_[0-9]*.log",
    "Svc.*.log",

    # ── Job / backup-copy logs ────────────────────────────────────────────────
    "Job.*.log",
    "BackupCopy.*.log",

    # ── Agent and endpoint logs ───────────────────────────────────────────────
    "Agent.*.log",
    "AgentUpdater*.log",
    "EP.*.log",
    "Endpoint.*.log",

    # ── Task / RPC / transport infrastructure ────────────────────────────────
    "Task.*.log",
    "Rpc.*.log",
    "RPCAssemblyServer.log",
    "RTS.ResourcesUsage*.log",

    # ── WMI / infrastructure ─────────────────────────────────────────────────
    "WmiServer.*.log",
    "WmiServer.log",

    # ── Named core service logs ───────────────────────────────────────────────
    "VeeamBackupManager.log",
    "VeeamPowerShell.log",
    "CatalogReplicationJob.log",
    "Veeam.WebApp.log",
    "VeeamDeployer*.log",

    # ── Mount service ─────────────────────────────────────────────────────────
    "Mount.*.log",
    "MountSvc.log",

    # ── Data collection ───────────────────────────────────────────────────────
    "DataCollectionService*.log",

    # ── Satellite (Cloud Connect / off-site seeding) ─────────────────────────
    "Satellite*.log",

    # ── Distribution Server / scale-out repository ────────────────────────────
    "Dis*.log",
    "DisServer*.log",
    "DistributionSvc.log",

    # ── Database / storage infrastructure ────────────────────────────────────
    "Database*.log",
    "DB.*.log",
    "DbPlugin*.log",
    "DbPluginRedist.log",
    "StorageMeta*.log",
    "StorageSync*.log",

    # ── Catalog / search service ──────────────────────────────────────────────
    "Catalog*.log",

    # ── Repository service ────────────────────────────────────────────────────
    "RepoService*.log",
    "Repo.*.log",

    # ── Broker / orchestration ────────────────────────────────────────────────
    "Broker*.log",

    # ── Cloud Connect gateway ─────────────────────────────────────────────────
    "Gateway*.log",
    "CloudGateway*.log",

    # ── CDP (Continuous Data Protection) logs ────────────────────────────────
    "CCdp*.log",
    "CDP_Policy_*.log",
    "CdpPolicy*.log",
    "CdpService*.log",

    # ── Archive / SOBR offload ────────────────────────────────────────────────
    "ArchiveCleanup*.log",
    "ArchiveSync*.log",
    "SOBR_Offload*.log",
    "Offload_*.log",
    "ShadowBackupSync*.log",

    # ── Backup management / maintenance ───────────────────────────────────────
    "AnalyticsService*.log",
    "AutoProlongate.log",
    "BackupDatabase*.log",
    "BackupSrv*.log",
    "BackupUpdateSvc.log",
    "BackupVersionChecker*.log",
    "BackupWeb*.log",
    "BackupSuite_*.log",
    "BadRequestRegister.log",
    "CleanupExpiredRetrievals.log",
    "Copy_backup_*.log",
    "Move_backup_*.log",
    "SetupBackup*.log",
    "SuiteEngine_*.log",
    "LogAnalyzer*.log",

    # ── Watchdog and background worker logs ──────────────────────────────────
    "AvailabilityWatchdog*.log",
    "BackgroundActivityWatchdog.log",
    "CloudDatastore*.log",
    "CloudGateDispatcher.log",
    "CloudProvider*.log",
    "CloudThrottling*.log",
    "DaemonDiskOwnershipWatchdog.log",
    "HostEvents*.log",
    "PolicySessions*.log",
    "ProxyChanges*.log",
    "RestorePoint*.log",
    "TargetDatastore*.log",
    "TaskActivityWatchdog.log",

    # ── Cloud provider plugin logs ────────────────────────────────────────────
    "AWSPlugin*.log",
    "EntraIdPlugin*.log",
    "GCPPlugin*.log",
    "KVMPlugin*.log",
    "MicrosoftAzurePlugin*.log",
    "Microsoft_Azure_*.log",
    "NutanixAHV*.log",
    "PVEPlugin*.log",
    "RHVPlugin*.log",

    # ── Application explorer / database integration logs ──────────────────────
    "ADExplorer.log",
    "Exchange*.log",
    "MongoDBExplorer.log",
    "OracleExplorer.log",
    "OracleLib.log",
    "PostgreSqlExplorer.log",
    "SapHanaExplorer.log",
    "SharePoint*.log",
    "SmartObject.log",
    "SQLExplorer.log",

    # ── FLR / restore / driver logs ───────────────────────────────────────────
    "Disk.*.log",
    "Driver.VeeamFLR*.log",
    "FilesysVss*.log",
    "FLR_*.log",
    "FlrDrv*.log",

    # ── Misc Veeam component logs ─────────────────────────────────────────────
    "Audit*.log",
    "Collector*.log",
    "Common.log",
    "crash.Veeam.*.log",
    "ExternalRepo*.log",
    "Full.log",
    "I_O_filter_deployment.log",
    "InstallerSvc.log",
    "Listener.log",
    "Main.log",
    "OneAgent*.log",
    "PluginImmutabilityUpdater.log",
    "PostgresConfigurator_*.log",
    "Record.log",
    "RemedyService*.log",
    "ReplicationState*.log",
    "Reports.log",
    "ReportViewer.log",
    "SaveMetaAgent*.log",
    "ServiceFail.log",
    "Session.log",

    # ── Log-shipping logs ─────────────────────────────────────────────────────
    "*.logshipping.log",

    # ── Transport ctrl / session logs (CDP/NBS agent connections) ────────────
    # e.g. sabp-dba-rdp20_vm-8660.ctrl.log, SABPVEEAM-21_vm-3243.ctrl_06022026.log
    "*.ctrl.log",
    "*.ctrl_*.log",

    # ── IP-addressed transport session logs ──────────────────────────────────
    # e.g. 10.203.244.245.log, 10.235.248.10.log (named after destination IP)
    "[0-9][0-9].[0-9]*.log",

    # ── GUID-named transport / session logs ───────────────────────────────────
    # e.g. 8901548d-f98c-7f44-b030-cce36cec0c10.log
    "????????-????-????-????-????????????.log",

    # ── Catch-all for other top-level Veeam service logs ─────────────────────
    "Veeam*.log",
]
# Matches the opening bracket-timestamp pattern common to all Veeam log variants.
# The (?:\.\\d+)? handles optional fractional seconds in NFS/transport logs.
# Stops at < (without requiring \d+ immediately) to allow < 10580> style threads.
content_match = '^\[\d{2}\.\d{2}\.\d{4}\s\d{2}:\d{2}:\d{2}(?:\.\d+)?\]\s<'

[parsing]
# Named groups: timestamp, thread, level, message
#
# Handles two Veeam log variants:
#
#   VBR service logs (Job.*, Svc.VeeamBackup.*, etc):
#     [23.11.2016 23:07:16] <01> Info     ------- Job Started -------
#
#   NFS / transport service logs (Svc.VeeamNFS.log, Svc.VeeamTransport.log):
#     [26.02.2026 22:07:56.535] < 10580> nfstcps | ERR |Error occurred...
#
# Key regex changes vs the original VBR-only pattern:
#   (?:\.\d+)?          -- optional fractional seconds (.535)
#   <\s*...\s*>         -- optional whitespace inside thread brackets (< 10580>)
#   (?:level_kw\s+)?    -- level field is optional; uses an explicit keyword
#                          list so component names (nfstcps) are NOT captured
#                          as the severity, allowing severity_override to fire.
line_pattern = '^\[(?P<timestamp>\d{2}\.\d{2}\.\d{4}\s\d{2}:\d{2}:\d{2})(?:\.\d+)?\]\s<\s*(?P<thread>\d+)\s*>\s(?:(?P<level>Info|Warning|Warn|Error|Err|Fatal|Critical|Debug|Verbose|Success|Trace)\s+)?(?P<message>.+)$'
timestamp_format = "%d.%m.%Y %H:%M:%S"
multiline_mode = "continuation"

[severity_mapping]
critical = ["Critical", "Fatal"]
error = ["Error", "Err"]
warning = ["Warning", "Warn"]
info = ["Info", "Success"]
debug = ["Debug", "Verbose", "Trace"]

# Regex-based second-chance classification applied when the captured level
# string is not in severity_mapping (e.g. vendor-specific tokens) or for
# continuation lines that become plain message text.
# (?i) enables case-insensitive matching so ERR, WARN, FAILED, etc. all fire.
[severity_override]
critical = ['(?i)\bFATAL\b', '(?i)\bCRITICAL\b']
error    = ['(?i)\bFailed\b', '(?i)\bException\b', '(?i)\bError\b', '(?i)Unable to', '(?i)Cannot ']
warning  = ['(?i)\bWarn(ing)?\b', '(?i)\bTimeout\b', '(?i)\bRetry\b']
info     = ['(?i)\bSucceed\b', '(?i)\bCompleted\b']
