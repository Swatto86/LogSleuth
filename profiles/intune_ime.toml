# LogSleuth Format Profile: Microsoft Intune Management Extension (CMTrace)
#
# The Intune Management Extension (IME) and related Intune agent components
# write logs in CMTrace/SCCM XML-attribute format.  Every log entry is a
# single line with this structure:
#
#   <![LOG[message text here]LOG]!><time="HH:MM:SS.mmm+offset"
#     date="M-D-YYYY" component="ComponentName" context="" type="N"
#     thread="ThreadId" file="SourceFile.cpp">
#
# The `type` attribute controls severity:
#   1 = Information
#   2 = Warning
#   3 = Error
#
#
# Covered log files:
#   IntuneManagementExtension.log / IntuneManagementExtension-<date>.log
#   AgentExecutor.log
#   SidecarExtension.log
#   EventCollector.log
#   Microsoft.Management.Services.IntuneWindowsAgent.log
#
# Log locations:
#   Windows: C:\ProgramData\Microsoft\IntuneManagementExtension\Logs\
#   Exported via: mdmdiagnosticstool.exe -area DeviceEnrollment;DeviceProvisioning -zip <path>

[profile]
id = "intune-ime"
name = "Microsoft Intune Management Extension"
version = "1.0"
description = "Intune IME and agent CMTrace-format logs (IntuneManagementExtension.log, AgentExecutor.log, etc.)"
log_locations = [
    "Windows: C:\\ProgramData\\Microsoft\\IntuneManagementExtension\\Logs\\",
    "MDM Diagnostics: run mdmdiagnosticstool.exe -area DeviceEnrollment;DeviceProvisioning -zip <path>",
]

[detection]
file_patterns = [
    "IntuneManagementExtension*.log",
    "AgentExecutor*.log",
    "SidecarExtension*.log",
    "EventCollector*.log",
    "Microsoft.Management.Services.IntuneWindowsAgent.log",
]
# The <![LOG[ prefix is unique to CMTrace-format logs
content_match = '^\<!\[LOG\['

[parsing]
# Named groups:
#   message   — log text between <![LOG[  and  ]LOG]!>
#   timestamp — M-D-YYYY from the date= attribute (date precision).
#               The time= attribute appears first in the line, making a single
#               combined date+time capture impractical with a regex alone.
#               Date-only precision is sufficient for day-level timeline
#               placement and daily filtering.  Hour/minute precision requires
#               a future parser enhancement (multi-group timestamp assembly).
#   component — component name from the component= attribute
#   level     — numeric severity from the type= attribute (1/2/3)
#   thread    — thread ID from the thread= attribute
line_pattern = '^\<!\[LOG\[(?P<message>.*?)\]LOG\]!\>\<time="[^"]+"\s+date="(?P<timestamp>\d{1,2}-\d{1,2}-\d{4})"\s+component="(?P<component>[^"]*)"\s+context="[^"]*"\s+type="(?P<level>\d)"\s+thread="(?P<thread>[^"]*)"\s+file="[^"]*"\>$'
timestamp_format = "%m-%d-%Y"
multiline_mode = "skip"

[severity_mapping]
error   = ["3"]
warning = ["2"]
info    = ["1"]
